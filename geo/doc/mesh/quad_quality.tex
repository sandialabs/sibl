% --------------
% DOCUMENT CLASS
% --------------
% \documentclass[10pt,twoside,letterpaper,fleqn]{report}
%%%%%
%%%%% ----------------- black on white -> white on black %%%%%
% Option 1 of 2: article
%\documentclass[11pt,letterpaper,fleqn]{report}
% Option 2 of 2: slides
\documentclass[14pt,letterpaper,fleqn]{extreport}
%
%\documentclass[11pt, oneside]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.
%\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
\geometry{landscape}                		% Activate for rotated page geometry
\usepackage{pagecolor}
\definecolor{hred}{rgb}{1,0,0}
\definecolor{hivory}{rgb}{1,1,0.94}
\definecolor{hdarkblueblack}{RGB}{30,30,40}
\definecolor{hdarkgrayblack}{RGB}{35,35,35}
%\definecolor{hdarkgrayblack}{RGB}{30,30,30}
%\definecolor{hdarkgrayblack}{RGB}{25,25,25}
\pagecolor{hdarkgrayblack} % toggle on for dark mode
\color{white} % toggle on for dark mode
%%%%% ----------------- black on white -> white on black %%%%%
%%%%%



%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or eps§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb}

% % listings begin
\usepackage{listings}
% \providecommand{\GitRemote}{}
% \providecommand{\GitIdentifier}{master}
% \providecommand{\GitCheckout}[2][\GitIdentifier]{%
% % #1 being the version/branch
% % #2 being the file
% | \string"git archive --remote=\GitRemote #1 \detokenize{#2} 2>/dev/null | tar --extract --file - --to-stdout \string"%
% }
% % listings end

\usepackage{tikz}
\usetikzlibrary{positioning}
\usepackage{mathtools}

\usepackage{hyperref}
\usepackage{xcolor}
\definecolor{medium-blue}{rgb}{0,0,1}
\hypersetup{colorlinks, urlcolor={medium-blue}}

\usepackage{footmisc}
%SetFonts

%SetFonts

% External dependencies
\usepackage{pagecolor}
\input{../../../../include/hmath_descendant.tex}
% \input{https://github.com/hovey/include/blob/a9bf6db0394b5ba19e69653519a96c10eeb1e133/hmath_descendant.tex}
% https://tex.stackexchange.com/questions/500463/using-listinputlisting-to-include-a-specific-git-commit
% https://git-scm.com/docs/git-archive
% https://tex.stackexchange.com/questions/500463/using-listinputlisting-to-include-a-specific-git-commit

\title{Quadrilateral Quality}
\author{C.B.~Hovey}
%\date{}							% Activate to display a given date or n date

\begin{document}
\maketitle
%\section{}
%\subsection{}

% renewcommand{\GitRemote}{ssh://git@trac.sagemath.org/sage.git}
% \lstinputlisting{\GitCheckout{src/sage/coding/goppa.py}}
% \renewcommand{\GitRemote}{ssh://git@github.com:hovey/include.git}
% \lstinputlisting{\GitCheckout{hovey/include/hmath_descendant.tex}}

% \lstinputlisting{|\string"git archive --remote=ssh://git@server/repo.git VERSION path/to/file 2>/dev/null | tar --extract --file - --to-stdout\string"}
% \lstinputlisting{|\string"git archive --remote=ssh://git@github.com:hovey/include.git v0.0.1 hmath_descendant.tex 2>/dev/null | tar --extract --file hmath_descendant.tex --to-stdout\string"}
% \lstinputlisting{|\string"git archive --remote=https://git@github.com/hovey/include.git include/hmath_descendant.tex 2>/dev/null | tar --extract --file hmath_descendant.tex --to-stdout\string"}
% \lstinputlisting{|\string"git archive --remote=https://git@github.com/hovey/include.git v0.0.1 include/hmath_descendant.tex 2>/dev/null | tar --extract --file - --to-stdout\string"}

% Define the layers to draw the diagram
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}


\begin{figure}[htb]
  \begin{center}

    \begin{tikzpicture}
      % background grid
      %\draw[step=1cm,blue,dashed,very thin] (-9,0) grid (5,8);
      % \foreach \x in {-9, -8, -6, -4, -2, 0, 2, 4, 5}
      %   \draw (\x cm,1pt) -- (\x cm,-1pt) node[anchor=north] {$\x$};
      % \foreach \y in {0, 2, 4, 6, 8}
      %   \draw (1pt,\y cm) -- (-1pt,\y cm) node[anchor=east] {$\y$};         
          
     % physical space
      %\node[draw,align=left] at (2,8.5) {(b) Physical Space}; % boxed
      \node[align=left, text=black] at (2,8.5) {(b) Physical Space $\vx = (x, y)$}; % unboxed
      % x-axis
      \draw[black,thick,->] (-1,0) -- (5,0) node[anchor=north west]{$x$};
      % y-axis
      \draw[black,thick,->] (-1,0) -- (-1,5) node[anchor=south east]{$y$};
      % origin
      \filldraw[black] (-1,0) circle (2pt) node[anchor=east]{$O$};


      % parametric space
      %\node[draw,align=left] at (-6,8.5) {(a) Parametric Space};  % boxed
      \node[align=left, text=black] at (-6,8.5) {(a) Parametric Space $\ve{\xi} = (\xi, \eta)$};  % unboxed
      % xi-axis
      \draw[black,thick,dashed,->] (-9,4) -- (-3,4) node[anchor=west]{$\xi$};
      % eta-axis
      \draw[black,thick,dashed,->] (-6,1) -- (-6,7) node[anchor=south]{$\eta$};

      % \draw[step=1cm,gray,very thin] (-8,2) grid (-4,6);  % grid
      % grid lines mapped from parameter space to physical space
      % center of grid is in figure space at (-6, 4)
      \draw[green, thick] (-7, 2) -- (-7, 6); % vertical grid 1
      \draw[yellow, thick] (-6, 2) -- (-6, 6); % vertical grid 2
      \draw[cyan, thick] (-5, 2) -- (-5, 6); % vertical grid 3
      \draw[brown, thick] (-8, 3) -- (-4, 3); % horizontal grid 1
      \draw[red, thick] (-8, 4) -- (-4, 4); % horizontal grid 2
      \draw[gray, thick] (-8, 5) -- (-4, 5); % horizontal grid 3

      % xi-axis mapped to physical space
      \draw[black,thick,dashed,->] (-0.5,3.8125) -- (5.5,3.4375) node[anchor=west]{$\xi$};
      % eta-axis mapped to physical space
      \draw[black,thick,dashed,->] (2.5,0.8125) -- (2.5,6.43775) node[anchor=south]{$\eta$};

      % grid lines mapped from parameter space to physical space
      \draw[green, thick] (1.75, 1.625) -- (1.25, 5.75); % vertical grid 1
      \draw[yellow, thick] (2.5, 1.75) -- (2.5, 5.5); % vertical grid 2
      \draw[cyan, thick] (3.25, 1.875) -- (3.75, 5.25); % vertical grid 3
      \draw[brown, thick] (0.75, 2.625) -- (4.25, 2.75); % horizontal grid 1
      \draw[red, thick] (0.5, 3.75) -- (4.5, 3.5); % horizontal grid 2
      \draw[gray, thick] (0.25, 4.875) -- (4.75, 4.25); % horizontal grid 3

      \draw[blue, thick] (-8,2) -- (-4,2);  % nodes 1-2
      \draw[blue, thick] (-4,2) -- (-4,6);  % nodes 2-3
      \draw[blue, thick] (-4,6) -- (-8,6);  % nodes 3-4
      \draw[blue, thick] (-8,6) -- (-8,2);  % nodes 4-1
      
      \filldraw[black] (-8,2) circle (2pt) node[anchor=north]{node $1$}; 
      \node[anchor=north, black] at (-8,1.5) {$\ve{\xi}= (-1, -1)$};  
      
      \filldraw[black] (-4,2) circle (2pt) node[anchor=north]{node $2$};  
      \node[anchor=north, black] at (-4,1.5) {$\ve{\xi}= (1, -1)$};  
      
      \filldraw[black] (-4,6) circle (2pt) node[anchor=south]{node $3$};
      \node[anchor=south, black] at (-4,6.5) {$\ve{\xi}= (1, 1)$};  

      \filldraw[black] (-8,6) circle (2pt) node[anchor=south]{node $4$};
      \node[anchor=south, black] at (-8,6.5) {$\ve{\xi}= (-1, 1)$};  
      
      \draw[blue, thick] (1,1.5) -- (4,2);  % nodes 1-2
      \draw[blue, thick] (4,2) -- (5,5);  % nodes 2-3
      \draw[blue, thick] (5,5) -- (0,6);  % nodes 3-4      
      \draw[blue, thick] (0,6) -- (1,1.5);  % nodes 4-1            
      
      \filldraw[black] (1,1.5) circle (2pt) node[anchor=north]{node $1$}; 
      \node[anchor=north, black] at (1,1) {$\vx = (x_1, y_1)$};  

      \filldraw[black] (4,2) circle (2pt) node[anchor=north west]{node $2$}; 
      \node[anchor=north west, black] at (4,1.5) {$\vx = (x_2, y_2)$};  

      \filldraw[black] (5,5) circle (2pt) node[anchor=south west]{node $3$}; 
      \node[anchor=south west, black] at (5,5.5) {$\vx = (x_3, y_3)$};  
      
      \filldraw[black] (0,6) circle (2pt) node[anchor=south]{node $4$}; 
      \node[anchor=south, black] at (0,6.5) {$\vx = (x_4, y_4)$};  

      % Background
      \begin{pgfonlayer}{background}
        \path (-10.25cm, -1.0cm) node (bottomleft) {};
        \path (8.25cm, 9.5cm) node (topright) {};

        \path[fill=gray!10] (bottomleft) rectangle (topright);
      \end{pgfonlayer}

    \end{tikzpicture}

  \end{center}

  \caption{Parametric mapping $\vx = f(\ve{\xi})$ from parametric space to physical space.}
\label{fig:parametric_to_physical} % label must come after caption 
\end{figure}

\clearpage

\chapter{Quality}

\section{Isoparametric Mapping}
Let the parametric mapping $f: \ve{\xi} \in [-1, 1] \times [-1, 1] \mapsto \vx \in \real^2$ be defined as

\begin{align}
  x(\xi,\eta) & = \sum_{a=1}^4 N_a(\xi, \eta) \; x_a, \label{eq:shapex} \\
  y(\xi,\eta) & = \sum_{a=1}^4 N_a(\xi, \eta) \; y_a, \label{eq:shapey}
\end{align}
%\be
%x(\xi,\eta) = \sum_{a=1}^4 N_a(\xi, \eta) \; x_a, \mbox{ and }
%y(\xi,\eta) = \sum_{a=1}^4 N_a(\xi, \eta) \; y_a, 
%\ee
where a nodal {\bf shape function} is defined for each of the four nodes
\begin{align}
  N_1(\xi, \eta) & \defe \tfrac{1}{4} (1 - \xi) (1 - \eta), \\
  & \nonumber \\
  N_2(\xi, \eta) & \defe \tfrac{1}{4} (1 + \xi) (1 - \eta), \\
  & \nonumber \\
  N_3(\xi, \eta) & \defe \tfrac{1}{4} (1 + \xi) (1 + \eta), \\
  & \nonumber \\
  N_4(\xi, \eta) & \defe \tfrac{1}{4} (1 - \xi) (1 + \eta).
\end{align}

\clearpage

\section{Jacobian}

For the quadrilateral element, the Jacobian $\vJ$ is calculated as 
the matrix of partial derivatives of $\vx = (x, y)$ with 
respect to $\ve{\xi} = (\xi, \eta)$, 
\be 
 \vJ(\xi, \eta) \defe 
 \left[
  \frac{\partial \vx}{\partial \ve{\xi}}
 \right]
 = 
 \left[
  \begin{tabular}{cc}
    $x,_{\tiny\xi}$ & $x,_{\tiny\eta}$ \\
    $y,_{\tiny\xi}$ & $y,_{\tiny\eta}$ 
  \end{tabular}
  \right].
\ee 
Substituting $x(\xi, \eta)$ and $y(\xi, \eta)$ with shape function equations
(\ref{eq:shapex})-(\ref{eq:shapey}) and expanding terms,  the Jacobian takes 
the form 
\be 
 \vJ(\xi, \eta) = \frac{1}{4} 
 \left[
  \begin{tabular}{rrrr}
    $-1 + \eta$ & $1 - \eta$ & $1 + \eta$ & $-1 - \eta$ \\
    $-1 + \xi$ & $-1 - \xi$ & $1 + \xi$ & $1 - \xi$ 
  \end{tabular}
  \right]
  \left[ 
  \begin{tabular}{cc}
    $x_1$ & $y_1$ \\
    $x_2$ & $y_2$ \\
    $x_3$ & $y_3$ \\
    $x_4$ & $y_4$ \\
  \end{tabular}
  \right].
\ee 
The determinant of the Jacobian, $\det(\vJ)$, can be found to be 
\be 
\det(\vJ\left(\xi, \eta)\right) = c_0 + c_1 \xi + c_2 \eta,
  \label{eq:detJ}
\ee 
where
\begin{align}
  c_0 & = \frac{1}{8} \left[(x_1 - x_3) (y_2 - y_4) - (x_2 - x_4) (y_1 - y_3) \right], \\
  c_1 & = \frac{1}{8} \left[(x_3 - x_4) (y_1 - y_2) - (x_1 - x_2) (y_3 - y_4) \right], \\
  c_2 & = \frac{1}{8} \left[(x_2 - x_3) (y_1 - y_4) - (x_1 - x_4) (y_2 - y_3) \right].
\end{align}

\clearpage

\section{Quality}

We follow {\em The Verdict Geometry Quality Library} 
documentation\footnote{Knupp PM, Ernst CD, Thompson DC, Stimpson CJ, Pebay PP. 
The verdict geometric quality library. Sandia National Laboratories (SNL), 
Albuquerque, NM, and Livermore, CA (United States); 2006 Mar 1.  
OSTI \href{link}{https://www.osti.gov/servlets/purl/901967}.}~%footnote
and 
implementation\footnote{See
\href{link}{https://github.com/Kitware/VTK/blob/master/ThirdParty/verdict/vtkverdict/}
and in particular, the {\tt quad\_scaled\_jacobian} function in the {\tt V\_QuadMetric.cpp} implementation.}~%footnote
for the definitions of
quality metrics.  
The SNL Cubit help manual is also helpful.\footnote{See \href{link}{https://cubit.sandia.gov/files/cubit/16.04/help\_manual/WebHelp/cubithelp.htm}
%%or \href{link}{https://coreform.com/cubit\_help/mesh\_generation/mesh\_quality\_assessment/quadrilateral\_metrics.htm}.
}~%footnote

\subsection{Preliminaries}

Let the four edge vectors and their respective lengths be defined as
\begin{align}
 \ve{e}_1 & \defe \vx_2 - \vx_1, \hspace{2cm} \ell_1 \defe \; \norm{\ve{e}_1}, \\
 \ve{e}_2 & \defe \vx_3 - \vx_2, \hspace{2cm} \ell_2 \defe \; \norm{\ve{e}_2}, \\
 \ve{e}_3 & \defe \vx_4 - \vx_3, \hspace{2cm} \ell_3 \defe \; \norm{\ve{e}_3}, \\
 \ve{e}_4 & \defe \vx_1 - \vx_4, \hspace{2cm} \ell_4 \defe \; \norm{\ve{e}_4}.
\end{align}
%
The two (non-normalized) {\em principal axes} are the defined though vector addition
of the two opposing side lengths
\begin{align}
 \vX & \defe \ve{e}_1 - \ve{e}_3 = (\vx_2 - \vx_1) - (\vx_4 - \vx_3), \\
 \vY & \defe \ve{e}_2 - \ve{e}_4 = (\vx_3 - \vx_2) - (\vx_1 - \vx_4).
\end{align}
%
At each vertex, there is a normal vector and its respective normalized unit vector
\begin{align}
 \ve{N}_1 & \defe \ve{e}_4 \times \ve{e}_1, \hspace{2cm} \hat{\ve{n}}_1 \defe \; \ve{N}_1 \; / \norm{\ve{N}_1}, \\
 \ve{N}_2 & \defe \ve{e}_1 \times \ve{e}_2, \hspace{2cm} \hat{\ve{n}}_2 \defe \; \ve{N}_2 \; / \norm{\ve{N}_2}, \\
 \ve{N}_3 & \defe \ve{e}_2 \times \ve{e}_3, \hspace{2cm} \hat{\ve{n}}_3 \defe \; \ve{N}_3 \; / \norm{\ve{N}_3}, \\
 \ve{N}_4 & \defe \ve{e}_3 \times \ve{e}_4, \hspace{2cm} \hat{\ve{n}}_4 \defe \; \ve{N}_4 \; / \norm{\ve{N}_4}.
\end{align}
%
At the center of the element, there is principal axis normal as well
\be
 \ve{N}_c  \defe \vX \times \vY, \hspace{2cm} \hat{\ve{n}}_c \defe \; \ve{N}_c \; / \norm{\ve{N}_c}.
\ee
There are four contributions to the quadrilateral area from each of the four nodal areas\footnote{\label{footnote:admonishment} It may be tempting to (erroneously) write
 $\hat{\ve{n}}_1 
 \overset{\tiny \mbox{2D}}{\longrightarrow}
 \hat{\ve{n}}_2 
 \overset{\tiny \mbox{2D}}{\longrightarrow}
 \hat{\ve{n}}_3 
 \overset{\tiny \mbox{2D}}{\longrightarrow}
 \hat{\ve{n}}_4
 \overset{\tiny \mbox{2D}}{\longrightarrow}
 \hat{\ve{n}}_c$
and
 $\alpha_1  \overset{\tiny \mbox{2D}}{\longrightarrow} \; \norm{\ve{N}_1}, 
 \alpha_2  \overset{\tiny \mbox{2D}}{\longrightarrow} \; \norm{\ve{N}_2},
 \alpha_3  \overset{\tiny \mbox{2D}}{\longrightarrow} \; \norm{\ve{N}_3},
 \alpha_4  \overset{\tiny \mbox{2D}}{\longrightarrow} \; \norm{\ve{N}_4}$
 given that for the 2D quadrilateral case, all unit norms are in the same plane.
 The problem with such a construction is that it destroys the sign information 
 carried by each normal vector.  
 For the non-degenerate case, the foregoing simplification is true, since all give normals
 will carry the same sign.  However, for degenerate cases, such as when a quadrilateral
 folds over onto itself, 
 the sign information is no longer homogeneous, and the sign information
 {\em must} be retained to accurately calculate Jacobian metrics that go negative.
}
\begin{align}
 \alpha_1 & \defe \ve{N}_1 \cdot \hat{\ve{n}}_c, \\
 \alpha_2 & \defe \ve{N}_2 \cdot \hat{\ve{n}}_c, \\
 \alpha_3 & \defe \ve{N}_3 \cdot \hat{\ve{n}}_c, \\
 \alpha_4 & \defe \ve{N}_4 \cdot \hat{\ve{n}}_c.
\end{align}
%

\subsection{Signed Area}
The {\bf signed area} SA is defined as the average of all nodal area contributions:
\be 
\mbox{SA} \defe \; \frac{\alpha_1 + \alpha_2 + \alpha_3 + \alpha_4}{4}.
\ee
The metric dimension is $L^2$ and the ideal (unit square) value is {\tt 1.0}.

\subsection{Skew}
The {\bf skew} is defined as the absolute value of the cosine of the angle
between the two principal axes:
\be
\mbox{skew} \defe \left| \; \frac{\vX}{\norm{\vX}} \cdot \frac{\vY}{\norm{\vY}} \; \right|.
\ee


\subsection{Aspect Ratio}

The {\bf aspect ratio} AR is defined as the maximum edge length ratios taken at the 
quadrilateral center.\footnote{Robinson J. CRE method 
of element testing and the Jacobian shape parameters. Engineering Computations. 
1987 Feb 1.}  
This can be expressed in terms of the norms of the principal axes as
\be 
\mbox{AR} = \max\left(
  \frac{\norm{\vX}}{\norm{\vY}}, 
  \frac{\norm{\vY}}{\norm{\vX}}, 
 \right)
\ee

{\em Alternatively}, the perimeter length multiplied by the maximum side length, 
divided by four times the area to define a triangle aspect ratio that is 
meaningful for quadrilaterals,\footnote{Knupp 2006, {\em op.~cit.} at 38.} with 
dimension $L^0$ and acceptable range $[1.0, 1.3]$.

%\begin{itemize}
%  \item Dimension: $L^0$.  
%  \item Acceptable range: $[1.0, 1.3]$.  
%  \item Citation: Knupp 2006\footnote{Knupp 2006, {\em op.~cit.} at 42.} and Knupp 2000.\footnote{Knupp PM. Achieving finite element mesh quality via optimization of the Jacobian matrix norm and associated quantities. Part II—a framework for volume mesh optimization and the condition number of the Jacobian matrix. International Journal for numerical methods in engineering. 2000 Jul 20;48(8):1165-85. OSTI \href{link}{https://www.osti.gov/servlets/purl/5009}.}%footnote
%\end{itemize}

\subsection{Minimum Jacobian}
The {\bf Minimum Jacobian} $J_{\min}$ is defined as the minimum pointwise area of local 
map at the four corners and center of quadrilateral\footnote{Knupp 2006, {\em op.~cit.}~at 42.}
\be 
J_{\min} \defe \min \left(\alpha_1, \alpha_2, \alpha_3, \alpha_4\right).
\ee 

\subsection{Minimum Scaled Jacobian}

The {\bf Minimum Scaled Jacobian} $\hat{J}_{\min}$ is the minimum nodal area divided by the 
lengths of the two edge vector connecting that point\footnote{Knupp 2006, {\em op.~cit.}~at 51.}
\be 
\hat{J}_{\min} \defe \min
  \left(
    \frac{\alpha_1}{\ell_4 \ell_1}, 
    \frac{\alpha_2}{\ell_1 \ell_2},
    \frac{\alpha_3}{\ell_2 \ell_3},
    \frac{\alpha_4}{\ell_3 \ell_4}
  \right),
\ee 
%
We warned previously in Footnote~\ref{footnote:admonishment} for Jacobians that 
errors may result if sign information is not properly retained.  We 
note a similar admonishment\footnote{It may (again) be tempting to (erroneously) 
write for the 2D case 
$\hat{J}_{\min} \overset{\tiny \mbox{2D}}{\longrightarrow} \; \min
  \left(
    \sin \theta_1, \sin \theta_2, \sin \theta_3, \sin \theta_4
  \right),$
where $\theta_1$ is the angle between $\ve{e}_4$ and $\ve{e}_1$, 
$\theta_2$ with $\ve{e}_1$ and $\ve{e}_2$, 
$\theta_3$ with $\ve{e}_2$ and $\ve{e}_3$, and
$\theta_4$ with $\ve{e}_3$ and $\ve{e}_4$.
Such a simplification will only work if $\ve{\theta}$ is retained as a vector quantity (thus 
retaining the sign).  If $\theta$ is considered only as a scalar, errors will result when
the Jacobian metric goes negative.} for Scaled Jacobians, since the latter is a function of the
former.

The dimension is $L^0$.  
The full range is  $[-1.0, 1.0]$.  
The acceptable range is typically taken as $[0.3, 1.0]$ in the generous case and 
$[0.5, 1.0]$ in the more restricted case.

\input{appendix.tex}


\end{document}
